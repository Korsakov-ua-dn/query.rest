# Query.rest

Формат query параметров REST API запросов для эффективной разработки фронта и бэка.
Решает проблему согласованности и выборки одним запросом связанных данных, сохраняя простоту REST.

Спецификация определяет несколько query параметров url запроса и не ограничивает применение 
дополнительных. Параметры опциональные. Именование допустимо изменять.

```
GET /objects?data=name,author(age)&cond[author.age]=18;30&sort=-name&limi=10&skip=0&lang=ru
```

- __[`data`](#data)__ - выбираемые данные.
  * [Свойства по умолчанию](data.md)
  * [Все свойства](data.md) - `*`
  * [Выборочные свойства](data.md) - `prop1, prop2(prop3)`
  * [Исключение свойства](data.md) - `!prop1`
  * [Свойства списка](data.md) - `items(prop1), count`
  * [Зависимость от типа объекта](data.md) - `id, author(name, manager:rating)`
  * [Рекурсивные шаблоны](data.md) - `comments(text, children(^))`
- __[`cond`](#cond)__ - условия выборки.
  * [Равенство значению](cond.md) - `cond[prop1]=value`
  * [Вхождение в строку](cond.md) - `cond[prop1]=*value`
  * [Вхождение с сначала строки](cond.md) - `cond[prop1]=^value`
  * [Полнотекстовый поиск](cond.md) - `cond[prop1]=~value`  
  * [Неравенство значению](cond.md) - `cond[prop1]=!value` 
  * [Больше, меньше значения](cond.md) - `cond[prop1]=>value`, `cond[prop1]=<value`
  * [Больше или равно, меньше или равно](cond.md) - `cond[prop1]=>>value`, `cond[prop1]=<<value`
  * [Диапазон значений](cond.md) - `cond[prop1]=min;max`
  * [Интервал значений](cond.md) - `cond[prop1]=min~max`
  * [Отсутствие свойства или значения](cond.md) `cond[prop1]=null`
  * [Выполнение любого улсовия](cond.md) - `cond[prop1]=cond1|cond2`
  * [Выполнение всех условий](cond.md) - `cond[prop1]=cond1&cond2`
  * [Множество любых условий]() - `cond[prop1]=value1|min2;max2|min3~max3|!value4|*value5|^value6|null`   
  * [Экранирование спец символов](cond.md) - `cond[prop1]=\!value`
  * [Условие на вложенное свойство](cond.md) - `cond[prop1.prop2]=value`
  * [Условие вывода свойства prop1](cond.md) - `cond.prop1[prop2]=value`
- __[`sort`](#sort)__ - сортировка.
- __[`limit`](#limit-skip)__ - ограничение количества объектов в списке.
- __[`skip`](#limit-skip)__ - с какой позиции вернуть ограниченное количество объектов.
- __[`depth`](#depth)__ - ограничение вложенности рекурсивных выборок.
- __[`lang`](#lang)__ - язык для i18n свойств.

## data

Выбираемые данные. 
Названия свойств объектов и их отношений, которые нужно получить одним запросом.

> Альтернативные названия: fields, props, select

В классическом REST API структура ответа жестко определяется сервером. Клиент получает лишние 
данные, либо сталкивается с нехваткой нужных. Например, связанные объекты нужно запрашивать 
отдельными запросами, имея их идентфикатор. Обработка параметра `data` решает эту проблему. 
Одним запросом можно выбрать все необходимые связанные данные и не запрашивать лишние.

_Выборка пользователей с указанием нужных свойств_
```
GET /users?data=id,email,avatar(url,extension)
```
```json
{
  "id":1,
  "email":"some@mail.com",
  "avatar":{
    "url": "/uploads/1928-212/5c2f3ed1fee590496c63759f.png",
    "extension": "png"
  }
}
```

## cond

Условие выборки.

> Альтернативные названия: filter, search, where

Параметром условия выборки указываются значения полей и способы сравнения значения со свойствами
объекта, напрмиер "больше или равно", "вхождение в диапазон", "перечисление значений" и другие. 
Допустимо указывать виртуальные поля, по которым формируются сложные условия на стороне бэкенда. 
Допустимые поля и условия для них определяет бэкенд. Назанчение параметра - передать бэку 
информацию, из которой будет формироваться полноценное условие поиска в базе данных.

Параметром можно указать несколько условий на разные поля. Поэтому применяется синтаксис квадратных
скобок. Формат не определет как логически услвоия будут объединться - И, ИЛИ, НЕ. Это зависит от
реализации сервера. Обычно улсовия объединяются через И. Но на усмотрнения бэкенда выборочные 
условия объдинять в соответсвии со спецификой запроса.

Условие равенства `cond[prop1]=value` сервер может реализовывать по любой логике, не обязательно
строгим равенством00. Потомучто параметр cond не стремиться определить все возможные условия, в ином 
случаи он станет сложным для использования и интерпретации бэком. 

> @todo: Отдельным параметром передавать логику объединения условий. Например 
```logic=price && (title || age)```

Условие может быть как на выбираемое множество объектов, так и на конкретное свойство объекта 
(обычно тоже множественное). Например, у товара множество точек продаж, выбирая сам товар, можем 
ограничить список точек продаж по определенному условию.

_Выборка товара с условием на него_
```
cond[price]=100;200  // Цена в диапазоне от 100 до 200 включительно
cond.stores[title]=*Magnit  // Магазины отфильтровать по названию - содержат Magnit
```

Через точку указывается, к какому свойству применить условие фильтра. Будет отфильтровано
само свойство у выбранных объектов. Если свойство не указано, то фильтр применяется к множеству 
запрашиваемых объектов. В квадратных скобках указывается свойство (или виртуальное поле), по 
которому будет сформировно условие фильтра.

## sort

Сортировка списков.

> Альтернативные названия: order

Параметром сортировки перечисляются поля с указанием направления сортировки.
Сортировать можно выбираемые объекты и их множественные свойства. Для сортировки свойств в названи
параметра sort через точку указывается свойство, которое сортировать. Свойства, по которым 
сортировать в строковом значении параметра.

_Сортировка товара и его свойства магазинов_
```
sort=-price,date // Сортировка по убыванию цены и возаратсанию даты
sort.stores=title // Список магазинов отсортировать по названию магазинов
```

## limit, skip

Ограничения списков

> Альтернативные названия: count, offset

Лимит и сдвиг ограничивают выборку объектов. Можно ограничить выборку множественных свойств объекта.

_Ограничение выбираемых товаров и их свойства магазинов_
```
limit=100
limit.stores=10

skip=10
skip.stores=0
```

## depth

Ограничение вложенности (глубины) при выборке иерерхических структур или рекурсивных связей.
Обычно указывается для свойств объекта.

_Выбор дерева страниц 2 уровня и комменответов на 4 уровня вложенности_
```
GET /pages?depth.chilren=2&depth.comments=4
```

Отсутствие параметра `depth` может трактоваться как выборка плоских данных, а при наличии depth c 
любым значением структуировать их в дерево, в качестве древовидных отношений бэкенд применятся
установки по умолчанию, например свойство children.

## lang

Параметр языка для случаев с мультиязычными свойствами, чтобы вернуть объекты со свойствами
в нужном языке. Можно указать разные языки для конкретных свойств объекта. 

_Язык для товаров и названия магазинов_
```
lang=en // язык для всех свойств
lang.stores.title=ru  // язык для заголовка магазинов
```

Параметр языка предагается как пример, по его подобию можно указывать валюту для цен, версию
изменений и другое.

## {custom}

Кастомные параметры предлагается реализовывать по образу и подобию предложенных форматов. 
Применять точки в названии для определений условий на соответсвующие свойства объектов.
Формат у значения параметра может быть любым, так как зависим от назначения, учитывать толкьо 
экранирование спец. символов URL.
